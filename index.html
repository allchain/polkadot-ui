<html>
<head>
	<script src="./nacl-fast.min.js"></script>
	<script src="./xxhash.min.js"></script>
	<script>
		function stringToSeed(s) {
			var data = new Uint8Array(32);
			data.fill(32);
			for (var i = 0; i < s.length; i++){
				data[i] = s.charCodeAt(i);
			}
			return data;
		}
		function stringToBytes(s) {
			var data = new Uint8Array(s.length);
			for (var i = 0; i < s.length; i++){
				data[i] = s.charCodeAt(i);
			}
			return data;
		}
		function hexToBytes(str) {
			if (!str) {
				return new Uint8Array();
			}
			var a = [];
			for (var i = 0, len = str.length; i < len; i += 2) {
				a.push(parseInt(str.substr(i, 2), 16));
			}

			return new Uint8Array(a);
		}
		function bytesToHex(uint8arr) {
			if (!uint8arr) {
				return '';
			}
			var hexStr = '';
			for (var i = 0; i < uint8arr.length; i++) {
				var hex = (uint8arr[i] & 0xff).toString(16);
				hex = (hex.length === 1) ? '0' + hex : hex;
				hexStr += hex;
			}

			return hexStr.toUpperCase();
		}
		function toLEHex(val, bytes) {
			let be = ('00'.repeat(bytes) + val.toString(16)).slice(-bytes * 2);
			var le = '';
			for (var i = 0; i < be.length; i += 2) {
				le = be.substr(i, 2) + le;
			}
			return le;
		}

		const CALLS = [{
			name: 'consensus',
			calls: []
		},{
			name: 'session',
			calls: []
		},{
			name: 'staking',
			calls: [{
				name: 'transfer',
				params: [
					{ name: 'dest', type: 'AccountId' },
					{ name: 'value', type: 'Balance' }
				]
			},{
				name: 'stake', params: []
			},{
				name: 'unstake', params: []
			}]
		}]
	</script>
</head>
<body>
	Sender: <input id="seed" onkeyup="updateInput(); updateExtrinsic()"/> = <input readonly id="pubkey"/><br/>
	<div style="color: #888; font-size: small; font-family: monospace">curl -H "Content-Type: application/json" -X POST --data '{"jsonrpc":"2.0","method":"state_getStorage","params":["0x<span id="balanceLocation"></span>"],"id":"1"}' 127.0.0.1:9933</div>

	Index: <input id="index" onkeyup="updateExtrinsic()" value="0"/><br/>
	Call: <select id="call" onchange="updateCall()"></select>
	<div id="params"></div>

	Inner: <input readonly id="inner"/><br/>
	Sig: <input readonly id="sig"/><br/>
	<div style="color: #888; font-size: small; font-family: monospace">curl -H "Content-Type: application/json" -X POST --data '{"jsonrpc":"2.0","method":"author_submitExtrinsic","params":["0x<span id="signed"></span>"],"id":"1"}' 127.0.0.1:9933</div>

	<script>
	function updateCalls() {
		let h = '';
		CALLS.forEach((mod, mi) => {
			if (mod.calls.length > 0) {
				h += `<optgroup label=${mod.name}>`;
				mod.calls.forEach((call, ci) => {
					h += `<option id="${mi}.${ci}">${call.name}</option>`;
				});
				h += `</optgroup>`;
			}
		})
		document.getElementById('call').innerHTML = h;
		updateCall();
	}
	function isValid(value, type) {
		switch (type) {
			case 'AccountId': return value.length == 20 && !Number.isNaN(Number.parseInt(value, 16));
			case 'Balance': return '' + +value == value;
			default: return false;
		}
	}
	function updateCall() {
		let id = document.getElementById('call').selectedOptions[0].id.split('.');
		let params = CALLS[id[0]].calls[id[1]].params;
		let h = '';
			//if (isValid(this.value, '${p.type}') { this.validity.badInput = false; updateExtrinsic(); } else this.validity.badInput = true;
		params.forEach(p => {
			h += `<div>${p.name}: <input id="param_${p.name}" onkeyup="updateExtrinsic()"></input></div>`;
		});
		document.getElementById('params').innerHTML = h;
		updateExtrinsic();
	}
	function encodedCall() {
		let id = document.getElementById('call').selectedOptions[0].id.split('.');
		let params = CALLS[id[0]].calls[id[1]].params;
		let h = id.map(i => toLEHex(i, 1)).join('');
		params.forEach(p => {
			let v = document.getElementById('param_' + p.name).value;
			switch (p.type) {
				case 'AccountId': {
					if (v.length == 20 && !Number.isNaN(Number.parseInt(v, 16)))
						h += v;
					else
						h += bytesToHex(nacl.sign.keyPair.fromSeed(stringToSeed(v)).publicKey);
					break;
				}
				case 'Balance': { h += toLEHex(+v, 8); break; }
			}
		});
		return h;
	}
	function updateInput() {
		let seed = document.getElementById("seed").value;
		let p = nacl.sign.keyPair.fromSeed(stringToSeed(seed));
		let pubkey = p.publicKey.reduce((memo, i) => memo + ('0' + i.toString(16)).slice(-2), '');
		document.getElementById("pubkey").value = pubkey;

		let loc = new Uint8Array([...stringToBytes('sta:bal:'), ...hexToBytes(pubkey)]);
		document.getElementById("balanceLocation").innerHTML =
			toLEHex(XXH.h64(loc.buffer, 0), 8) + toLEHex(XXH.h64(loc.buffer, 1), 8);
	}
	function updateExtrinsic() {
		var seed = document.getElementById("seed").value;
		var sender = document.getElementById("pubkey").value;
		var index = +document.getElementById("index").value;

		let ext = sender + toLEHex(index, 8) + encodedCall();

		document.getElementById("inner").value = ext;

		let p = nacl.sign.keyPair.fromSeed(stringToSeed(seed));
		let sig = bytesToHex(nacl.sign.detached(hexToBytes(ext), p.secretKey));
		document.getElementById("sig").value = sig;
		ext += sig;

		document.getElementById("signed").innerHTML = ext;
	}
	updateCalls();
	</script>
</body>
</html>
