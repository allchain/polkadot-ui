<html>
<head>
	<script src="./nacl-fast.min.js"></script>
	<script src="./xxhash.min.js"></script>
	<script>
		function stringToSeed(s) {
			var data = new Uint8Array(32);
			data.fill(32);
			for (var i = 0; i < s.length; i++){
				data[i] = s.charCodeAt(i);
			}
			return data;
		}
		function stringToBytes(s) {
			var data = new Uint8Array(s.length);
			for (var i = 0; i < s.length; i++){
				data[i] = s.charCodeAt(i);
			}
			return data;
		}
		function hexToBytes(str) {
			if (!str) {
				return new Uint8Array();
			}
			var a = [];
			for (var i = 0, len = str.length; i < len; i += 2) {
				a.push(parseInt(str.substr(i, 2), 16));
			}

			return new Uint8Array(a);
		}
		function bytesToHex(uint8arr) {
			if (!uint8arr) {
				return '';
			}
			var hexStr = '';
			for (var i = 0; i < uint8arr.length; i++) {
				var hex = (uint8arr[i] & 0xff).toString(16);
				hex = (hex.length === 1) ? '0' + hex : hex;
				hexStr += hex;
			}

			return hexStr.toUpperCase();
		}
		function toLEHex(val, bytes) {
			let be = ('00'.repeat(bytes) + val.toString(16)).slice(-bytes * 2);
			var le = '';
			for (var i = 0; i < be.length; i += 2) {
				le = be.substr(i, 2) + le;
			}
			return le;
		}
	</script>
</head>
<body>
	Sender: <input id="seed" onkeyup="updateInput(); updateExtrinsic()"/> = <input readonly id="pubkey"/><br/>
	Balance location: <input readonly id="balanceLocation"/><br/>

	Index: <input id="index" onkeyup="updateExtrinsic()" value="0"/><br/>
	Transfer: <input id="dest" onkeyup="updateExtrinsic()" value="d7568e5f0a7eda67a82691ff379ac4bba4f9c9b859fe779b5d46363b61ad2db9"/> <input id="amount" onkeyup="updateExtrinsic()" value="69"/><br/>

	Inner: <input readonly id="inner"/><br/>
	Sig: <input readonly id="sig"/><br/>
	Complete: <input readonly id="signed"/><br/>

	<script>
	function updateInput() {
		let seed = document.getElementById("seed").value;
		let p = nacl.sign.keyPair.fromSeed(stringToSeed(seed));
		let pubkey = p.publicKey.reduce((memo, i) => memo + ('0' + i.toString(16)).slice(-2), '');
		document.getElementById("pubkey").value = pubkey;

		let loc = new Uint8Array([...stringToBytes('sta:bal:'), ...hexToBytes(pubkey)]);
		document.getElementById("balanceLocation").value =
			toLEHex(XXH.h64(loc.buffer, 0), 8) + toLEHex(XXH.h64(loc.buffer, 1), 8);
	}
	function updateExtrinsic() {
		var seed = document.getElementById("seed").value;
		var sender = document.getElementById("pubkey").value;
		var index = +document.getElementById("index").value;
		var dest = document.getElementById("dest").value;
		var amount = +document.getElementById("amount").value;

		let ext = sender + toLEHex(index, 8) + '0200' + dest + toLEHex(amount, 8);

		document.getElementById("inner").value = ext;

		let p = nacl.sign.keyPair.fromSeed(stringToSeed(seed));
		let sig = bytesToHex(nacl.sign.detached(hexToBytes(ext), p.secretKey));
		document.getElementById("sig").value = sig;
		ext += sig;

		document.getElementById("signed").value = ext;
	}
	</script>
</body>
</html>
